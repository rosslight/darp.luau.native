name: Release Please

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.rp.outputs.release_created }}
      version: ${{ steps.rp.outputs.version }}
    steps:
      - name: Run release-please
        id: rp
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

  create-release:
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Resolve Luau version
        id: luau
        shell: bash
        run: |
          set -euo pipefail
          luau_tag="$(git -C native/luau describe --tags --exact-match 2>/dev/null || true)"
          if [[ -n "${luau_tag}" ]]; then
            luau_version="${luau_tag#v}"
          else
            luau_version="$(git -C native/luau rev-parse --short=12 HEAD)"
          fi
          echo "version=${luau_version}" >> "${GITHUB_OUTPUT}"

      - name: Build tag name
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          version="${{ needs.release-please.outputs.version }}"
          luau="${{ steps.luau.outputs.version }}"
          tag="v${version}+luau${luau}"
          echo "tag=${tag}" >> "${GITHUB_OUTPUT}"
          echo "Release tag: ${tag}"

      - name: Create tag and GitHub release
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag="${{ steps.tag.outputs.tag }}"

          # Idempotent: skip if the tag already exists
          if git rev-parse "refs/tags/${tag}" >/dev/null 2>&1; then
            echo "Tag ${tag} already exists, skipping."
            exit 0
          fi

          git tag "${tag}"
          git push origin "${tag}"

          gh release create "${tag}" \
            --title "${tag}" \
            --notes-file CHANGELOG.md