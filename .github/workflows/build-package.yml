name: Build and Test Package

on:
  pull_request:
  push:
  workflow_call:

jobs:
  build-native:
    name: Build native (${{ matrix.rid }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - rid: win-x64
            runner: windows-latest
            generator: Visual Studio 17 2022
          - rid: win-arm64
            runner: windows-latest
            generator: Visual Studio 17 2022
          - rid: linux-x64
            runner: ubuntu-latest
            generator: Ninja
          - rid: linux-arm64
            runner: ubuntu-24.04-arm
            generator: Ninja
          - rid: osx-x64
            runner: macos-latest-large
            generator: Ninja
          - rid: osx-arm64
            runner: macos-latest
            generator: Ninja
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build native runtime
        shell: pwsh
        run: ./scripts/build_native.ps1 -RuntimeId "${{ matrix.rid }}" -Generator "${{ matrix.generator }}"

      - name: Upload native runtime artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: artifacts/native/

  pack:
    name: Pack NuGet
    needs: build-native
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download native runtime artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: native-*
          path: artifacts/native
          merge-multiple: true

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Pack NuGet
        run: dotnet pack src/Darp.Luau.Native/Darp.Luau.Native.csproj -c Release -o artifacts/packages

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: packages
          path: |
            artifacts/packages/*.nupkg
            artifacts/packages/*.snupkg

  integration-test:
    name: Integration test (${{ matrix.os }})
    needs: pack
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
          - os: windows
            runner: windows-latest
          - os: macos
            runner: macos-latest
    env:
      CI: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: packages
          path: artifacts/packages

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Restore integration tests with package feed
        shell: pwsh
        run: |
          $source = (Resolve-Path "artifacts/packages").Path
          Write-Host "Package source: $source"
          dotnet restore tests/Darp.Luau.Native.IntegrationTests/Darp.Luau.Native.IntegrationTests.csproj `
            --source "https://api.nuget.org/v3/index.json" `
            --source "$source" `
            -p:UseLocalProjectReference=false
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

      - name: Run integration tests
        shell: pwsh
        run: |
          dotnet run `
            --project tests/Darp.Luau.Native.IntegrationTests/Darp.Luau.Native.IntegrationTests.csproj `
            -c Release `
            --no-restore `
            -p:UseLocalProjectReference=false
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
